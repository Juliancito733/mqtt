<!-- https://eclipse.dev/paho/clients/js/ -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MQTT Client</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container mt-5">
    <div class="card shadow-lg">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Cliente MQTT</h4>
      </div>
      <div class="card-body">
        <p class="text-muted">Solo se permiten mensajes XML. Se usar치 la etiqueta <code>&lt;mensaje&gt;</code>.</p>

        <div class="input-group mb-3">
          <input type="text" id="mensaje" class="form-control" placeholder="Escribe tu mensaje">
          <button class="btn btn-primary" onclick="enviarMensaje()">Enviar</button>
        </div>

        <h5 class="mt-4">Mensajes recibidos:</h5>
        <ul class="list-group" id="lista-mensajes"></ul>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
  <script>
    const client = new Paho.MQTT.Client("localhost", 80, "clientId" + parseInt(Math.random() * 1000));

    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({
      onSuccess: onConnect,
      onFailure: (e) => console.log("Fallo en la conexi칩n: ", e),
      useSSL: false
    });

    function onConnect() {
      console.log("Conectado al broker MQTT.");
      client.subscribe("tecnologias/prueba");
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("Conexi칩n perdida: " + responseObject.errorMessage);
      }
    }

    function wrapInXMLIfNeeded(texto) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(texto, "application/xml");
      const isValid = !doc.querySelector("parsererror");
      const isWrapped = doc.documentElement.nodeName === "mensaje";

      if (isValid && isWrapped) {
        return texto; 
      }

      const escapedText = texto
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      return `<mensaje>${escapedText}</mensaje>`;
    }

    function extractMensajeTexto(xmlString) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlString, "application/xml");
      const error = doc.querySelector("parsererror");
      if (error) return null;

      const mensajeTag = doc.querySelector("mensaje");
      return mensajeTag?.textContent || null;
    }

    function enviarMensaje() {
      const input = document.getElementById('mensaje');
      const mensajeTexto = input.value;
      if (mensajeTexto.trim() === "") return;

      const xmlMensaje = wrapInXMLIfNeeded(mensajeTexto);

      const message = new Paho.MQTT.Message(xmlMensaje);
      message.destinationName = "tecnologias/prueba";
      client.send(message);
      console.log("Mensaje enviado: " + xmlMensaje);
      input.value = "";
    }

    function onMessageArrived(message) {
      const payload = message.payloadString;
      console.log("Mensaje recibido: " + payload);

      const mensajeTexto = extractMensajeTexto(payload);
      if (mensajeTexto === null) {
        console.warn("Mensaje ignorado: no es XML v치lido con <mensaje>.");
        return;
      }

      const lista = document.getElementById('lista-mensajes');
      const item = document.createElement('li');
      item.className = 'list-group-item';
      item.textContent = `${new Date().toLocaleTimeString()} - ${mensajeTexto}`;
      lista.appendChild(item);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
